CREATE OR REPLACE PROCEDURE DEV_FRAUD_WAREHOUSE.FRAUD_REPORTS_ENT.TINNPI_FINDER_RESULTS("NPI" STRING, "TIN" STRING, "MINDATE" DATE)
RETURNS STRING
LANGUAGE JAVASCRIPT
EXECUTE AS OWNER
AS
$$
try {
// Step 1: Truncate table
    snowflake.execute({
        sqlText: `TRUNCATE TABLE DEV_FRAUD_WAREHOUSE.MONITORING_ENT.TINNPI_FINDER_RESULTS_V2`
    });

    // Step 2: Create table with SELECT INTO
    snowflake.execute({
        sqlText: `
        CREATE OR REPLACE TABLE DEV_FRAUD_WAREHOUSE.MONITORING_ENT.TINNPI_FINDER_RESULTS_V2 AS
        WITH claims AS (
    SELECT 
        FC.SOURCESYSTEMCLAIMID AS SRC_CLAIM_ID,
        CASE WHEN DIMDATERECEIVED.DATEDAY IS NULL THEN '-1' ELSE DIMDATERECEIVED.DATEDAY END RECEIVEDDATE,
        CASE WHEN SERVICEFROM.DATEDAY IS NULL THEN '-1' ELSE SERVICEFROM.DATEDAY END FROMDATEOFSERVICE,
        GETDATE() AS row_cre_dt,
        FC.SOURCESYSTEMID AS SRC_SOURCESYSTEMID,
        FC.SRC_UNIQ_CD AS SRC_UNIQ_CD,
        FC.DIMPROVIDERKEY AS BILLPROVIDERKEY,
        FC.DIMRENDERINGPROVIDERKEY AS RENDERPROVIDERKEY,
        FC.DIMATTENDINGPROVIDERKEY AS ATTENDINGPROVIDERKEY,
        FC.DIMREFERRINGPROVIDERKEY AS REFERRINGPROVIDERKEY,
        FC.DIMSERVICELOCATIONKEY AS SERVICELOCATIONPROVIDERKEY,
        CASE WHEN DIMPROVIDER.PROVIDERNPI IS NULL THEN '-1' ELSE DIMPROVIDER.PROVIDERNPI END CLNSD_NPI,
        DEV_ZDI_REFERENCES.SOURCES_INTERNAL.ZDI_PROVIDER_CLEAN_TIN(DIMPROVIDER.PMTAXID) AS CLNSD_TAX_ID,
        CASE WHEN DIMCLIENT.DIMCLIENTKEY IS NULL THEN '-1' ELSE DIMCLIENT.DIMCLIENTKEY END AS PAYERKEY,
        DIMCLIENT.financeparent AS FINANCE_PARENT_NAME,
        CASE WHEN DIMPROVIDER.DIMPROVIDERKEY IS NULL THEN '-1' ELSE DIMPROVIDER.DIMPROVIDERKEY END PROVIDERKEY
    FROM PROD_CCS_WAREHOUSE.CLAIMS_MART.FACTCLAIM FC
    LEFT JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMDATE DIMDATERECEIVED
        ON DIMDATERECEIVED.DIMDATEKEY = FC.DIMDATERECEIVEDKEY
    LEFT JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMDATE SERVICEFROM
        ON SERVICEFROM.DIMDATEKEY = FC.DIMDATESERVICEFROMKEY
    LEFT JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMPROVIDER DIMPROVIDER
        ON DIMPROVIDER.DIMPROVIDERKEY = FC.DIMPROVIDERKEY
    LEFT JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMCLIENT DIMCLIENT
        ON DIMCLIENT.DIMCLIENTKEY = FC.DIMCLIENTKEY
    WHERE FACTCLAIMID IS NOT NULL
),

all_trnx AS (
    SELECT 
        c.SRC_SOURCESYSTEMID::INT AS SOURCESYSTEMID,
        c.SRC_CLAIM_ID::VARCHAR(500) AS SOURCESYSTEM_TRANSACTION_ID,
        COALESCE(c.RECEIVEDDATE, c.FROMDATEOFSERVICE, c.ROW_CRE_DT)::DATE AS TRANSACTION_DATE,
        CASE 
            WHEN TRANSACTION_DATE = c.RECEIVEDDATE THEN 1 
            WHEN TRANSACTION_DATE = c.FROMDATEOFSERVICE THEN 2 
            WHEN TRANSACTION_DATE = c.ROW_CRE_DT THEN 3 
        END::INT AS DATE_SRCE_ID,
        c.PAYERKEY::INT AS PAYERKEY,
        1::INT AS NPI_ROLE_ID,
        c.CLNSD_NPI::VARCHAR(100) AS NPI,
        c.CLNSD_TAX_ID::VARCHAR(100) AS TIN,
		c.FINANCE_PARENT_NAME as FINANCE_PARENT_NAME
    FROM claims c
    INNER JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMPROVIDER prb ON c.BILLPROVIDERKEY = prb.DIMPROVIDERKEY
	 WHERE (NPI = '' || '''''''' ||:NPI|| '''''''' || '' or TIN = '' || '''''''' ||:TIN|| '''''''' || '' )
          and TRANSACTION_DATE >= '' || '''''''' ||:MINDATE|| '''''''' || ''

    UNION ALL
    SELECT 
        c.SRC_SOURCESYSTEMID::INT, c.SRC_CLAIM_ID::VARCHAR(500),
        COALESCE(c.RECEIVEDDATE, c.FROMDATEOFSERVICE, c.ROW_CRE_DT)::DATE AS TRANSACTION_DATE,
        CASE 
            WHEN TRANSACTION_DATE = c.RECEIVEDDATE THEN 1 
            WHEN TRANSACTION_DATE = c.FROMDATEOFSERVICE THEN 2 
            WHEN TRANSACTION_DATE = c.ROW_CRE_DT THEN 3 
        END::INT,
        c.PAYERKEY::INT, 2::INT, c.CLNSD_NPI::VARCHAR(100), c.CLNSD_TAX_ID::VARCHAR(100),c.FINANCE_PARENT_NAME as FINANCE_PARENT_NAME
    FROM claims c
    INNER JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMPROVIDER prb ON c.SERVICELOCATIONPROVIDERKEY = prb.DIMPROVIDERKEY
	 WHERE (NPI = '' || '''''''' ||:NPI|| '''''''' || '' or TIN = '' || '''''''' ||:TIN|| '''''''' || '' )
          and TRANSACTION_DATE >= '' || '''''''' ||:MINDATE|| '''''''' || ''

    UNION ALL
    SELECT 
        c.SRC_SOURCESYSTEMID::INT, c.SRC_CLAIM_ID::VARCHAR(500),
        COALESCE(c.RECEIVEDDATE, c.FROMDATEOFSERVICE, c.ROW_CRE_DT)::DATE AS TRANSACTION_DATE,
        CASE 
            WHEN TRANSACTION_DATE = c.RECEIVEDDATE THEN 1 
            WHEN TRANSACTION_DATE = c.FROMDATEOFSERVICE THEN 2 
            WHEN TRANSACTION_DATE = c.ROW_CRE_DT THEN 3 
        END::INT,
        c.PAYERKEY::INT, 3::INT, c.CLNSD_NPI::VARCHAR(100), c.CLNSD_TAX_ID::VARCHAR(100),c.FINANCE_PARENT_NAME as FINANCE_PARENT_NAME
    FROM claims c
    INNER JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMPROVIDER prb ON c.RENDERPROVIDERKEY = prb.DIMPROVIDERKEY
	 WHERE (NPI = '' || '''''''' ||:NPI|| '''''''' || '' or TIN = '' || '''''''' ||:TIN|| '''''''' || '' )
          and TRANSACTION_DATE >= '' || '''''''' ||:MINDATE|| '''''''' || ''

    UNION ALL
    SELECT 
        c.SRC_SOURCESYSTEMID::INT, c.SRC_CLAIM_ID::VARCHAR(500),
        COALESCE(c.RECEIVEDDATE, c.FROMDATEOFSERVICE, c.ROW_CRE_DT)::DATE AS TRANSACTION_DATE,
        CASE 
            WHEN TRANSACTION_DATE = c.RECEIVEDDATE THEN 1 
            WHEN TRANSACTION_DATE = c.FROMDATEOFSERVICE THEN 2 
            WHEN TRANSACTION_DATE = c.ROW_CRE_DT THEN 3 
        END::INT,
        c.PAYERKEY::INT, 4::INT, c.CLNSD_NPI::VARCHAR(100), c.CLNSD_TAX_ID::VARCHAR(100),c.FINANCE_PARENT_NAME as FINANCE_PARENT_NAME
    FROM claims c
    INNER JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMPROVIDER prb ON c.ATTENDINGPROVIDERKEY = prb.DIMPROVIDERKEY
	 WHERE (NPI = '' || '''''''' ||:NPI|| '''''''' || '' or TIN = '' || '''''''' ||:TIN|| '''''''' || '' )
          and TRANSACTION_DATE >= '' || '''''''' ||:MINDATE|| '''''''' || ''

    UNION ALL
    SELECT 
        c.SRC_SOURCESYSTEMID::INT, c.SRC_CLAIM_ID::VARCHAR(500),
        COALESCE(c.RECEIVEDDATE, c.FROMDATEOFSERVICE, c.ROW_CRE_DT)::DATE AS TRANSACTION_DATE,
        CASE 
            WHEN TRANSACTION_DATE = c.RECEIVEDDATE THEN 1 
            WHEN TRANSACTION_DATE = c.FROMDATEOFSERVICE THEN 2 
            WHEN TRANSACTION_DATE = c.ROW_CRE_DT THEN 3 
        END::INT,
        c.PAYERKEY::INT, 5::INT, c.CLNSD_NPI::VARCHAR(100), c.CLNSD_TAX_ID::VARCHAR(100),c.FINANCE_PARENT_NAME as FINANCE_PARENT_NAME
    FROM claims c
    INNER JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMPROVIDER prb ON c.REFERRINGPROVIDERKEY = prb.DIMPROVIDERKEY
	 WHERE (NPI = '' || '''''''' ||:NPI|| '''''''' || '' or TIN = '' || '''''''' ||:TIN|| '''''''' || '' )
          and TRANSACTION_DATE >= '' || '''''''' ||:MINDATE|| '''''''' || ''
)

SELECT distinct
    sys.SOURCESYSTEMNAME, trx.SOURCESYSTEM_TRANSACTION_ID, trx.TRANSACTION_DATE, dsc.DATE_SRCE_COL, trx.FINANCE_PARENT_NAME, 
                trx.TIN, npi.NPI, npi.ENTITY_TYPE_CODE, npi.PROVIDER_NAME, rol.NPI_ROLE
FROM all_trnx trx
LEFT JOIN DEV_FRAUD_WAREHOUSE.MONITORING_ENT.DIMSOURCESYSTEM sys ON sys.SOURCESYSTEMID = trx.SOURCESYSTEMID
LEFT JOIN DEV_FRAUD_WAREHOUSE.MONITORING_ENT.NPPES_NPI_THIN npi ON trx.NPI = npi.NPI
LEFT JOIN DEV_FRAUD_WAREHOUSE.MONITORING_ENT.CLAIM_NPI_ROLES rol ON rol.NPI_ROLE_ID = trx.NPI_ROLE_ID
LEFT JOIN DEV_FRAUD_WAREHOUSE.MONITORING_ENT.CLAIM_DATE_SOURCES dsc ON dsc.DATE_SRCE_ID = trx.DATE_SRCE_ID;`
    });


    return 'Procedure executed successfully.';

} catch (err) {
    return 'Failed: ' + err;
}
$$;