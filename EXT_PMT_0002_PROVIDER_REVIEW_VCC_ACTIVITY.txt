
-- PROVIDER METRICS
WITH PROV_METRICS AS 
    (
    SELECT 
        PROVIDERID,
        COUNT(DISTINCT COALESCE(MERCHANTNAME, ACCEPTOR)) AS PROVIDER_DISTINCT_ACCEPTORS,
        COUNT
            (CASE WHEN AUTHSTATUS = 'Declined'
            THEN TXNID
            ELSE 0
            END) AS PROVIDER_TOTAL_DECLINES,
        SUM
            (CASE WHEN AUTHSTATUS = 'Settled'
            THEN PYMTAMT
            ELSE 0
            END) AS PROVIDER_TOTAL_SETTLEMENT_AMOUNT,
        MAX(YEARMONTH) AS LAST_REPORT_DATE
    FROM PROD_FRAUD_WAREHOUSE.SRC_EML.ZELIS_PROVIDER_REVIEW
    GROUP BY PROVIDERID
    ),
PROV_BANKS AS
(SELECT DISTINCT
    PROVIDERID,
    BA.HB_BANK_ID
FROM PROV_METRICS P
LEFT JOIN PROD_FRAUD_WAREHOUSE.MONITORING_ENT.BANK_ACCOUNTS BA
ON P.PROVIDERID = BA.ENTITY_ID
AND ENTITY_TYPE = 'Provider'
),
CURRENT_PROV_PRODUCT AS
(
    SELECT DISTINCT
        PPLS.PROVIDERID,
        PPLS.PRODUCTLINEID,
        PLL.NAME AS PRODUCTNAME,
        SL.NAME AS STATUS,
        PPLS.ENABLED,
        PPLS.LASTMODIFIED
    FROM PROD_FRAUD_WAREHOUSE.SRC_EML.ZELIS_PROVIDER_REVIEW PR
    LEFT JOIN PROD_FRAUD_WAREHOUSE.SRC_PYMT_PPSBACKEND.PPS_PROVIDERPRODUCTLINESTATUS PPLS
    ON PR.PROVIDERID = PPLS.PROVIDERID
    LEFT JOIN PROD_FRAUD_WAREHOUSE.SRC_PYMT_PPSBACKEND.PPS_PRODUCTLINELOOKUP PLL
    ON PPLS.PRODUCTLINEID = PLL.PRODUCTLINEID
    LEFT JOIN PROD_FRAUD_WAREHOUSE.SRC_PYMT_PPSBACKEND.PPS_STATUSLOOKUP SL
    ON PPLS.STATUSID = SL.STATUSID
    ORDER BY PROVIDERID
),
PROVIDER_PRODUCT_ENROLLMENT AS
(
    SELECT
        CURRENT_PROV_PRODUCT.PROVIDERID,
        ARRAY_AGG(
            OBJECT_CONSTRUCT
                (
                'STATUS', CURRENT_PROV_PRODUCT.STATUS, 
                'PRODUCT', CURRENT_PROV_PRODUCT.PRODUCTNAME, 
                'LASTMODIFIED', TO_DATE(LASTMODIFIED)
                )
            ) AS PRODUCT_ENROLLMENT
    FROM CURRENT_PROV_PRODUCT
    GROUP BY CURRENT_PROV_PRODUCT.PROVIDERID
),

GROUP_ID AS
(
SELECT PROVIDERID,
       CONCAT(PROVIDERID,'_', MAX(YEARMONTH)) AS PROVIDER_GROUP_ID
FROM PROD_FRAUD_WAREHOUSE.SRC_EML.ZELIS_PROVIDER_REVIEW
GROUP BY PROVIDERID
),
FINAL_EXCEL_OUTPUT AS
(
SELECT DISTINCT
    GROUP_ID.PROVIDER_GROUP_ID,
    P.HB_PROVIDER_ID,
    PROV_BANKS.HB_BANK_ID,
    GROUP_ID.PROVIDERID,
    PPE.PRODUCT_ENROLLMENT,
    TO_VARCHAR(PROV_METRICS.PROVIDER_DISTINCT_ACCEPTORS) AS PROVIDER_DISTINCT_ACCEPTORS,
    TO_VARCHAR(PROV_METRICS.PROVIDER_TOTAL_DECLINES) AS PROVIDER_TOTAL_DECLINES,
    TO_VARCHAR(PROV_METRICS.PROVIDER_TOTAL_SETTLEMENT_AMOUNT) AS PROVIDER_TOTAL_SETTLEMENT_AMOUNT,
    PROV_METRICS.LAST_REPORT_DATE
FROM GROUP_ID
LEFT JOIN PROD_FRAUD_WAREHOUSE.MONITORING_ENT.PROVIDERS P
ON GROUP_ID.PROVIDERID = P.SYSTEMPROVIDERID 
AND P.SOURCESYSTEMID = 6
LEFT JOIN PROV_METRICS
ON GROUP_ID.PROVIDERID = PROV_METRICS.PROVIDERID
LEFT JOIN PROVIDER_PRODUCT_ENROLLMENT PPE
ON GROUP_ID.PROVIDERID = PPE.PROVIDERID
LEFT JOIN PROV_BANKS
ON GROUP_ID.PROVIDERID = PROV_BANKS.PROVIDERID 
ORDER BY GROUP_ID.PROVIDERID
),


--------------------------------------------------------------------------------------------------------
-- CREATE ARRAYS
--------------------------------------------------------------------------------------------------------
    FINAL_ARRAY AS
            (SELECT DISTINCT
                FINAL_EXCEL_OUTPUT.PROVIDER_GROUP_ID,
                FINAL_EXCEL_OUTPUT.HB_PROVIDER_ID,
                CASE 
                    WHEN FINAL_EXCEL_OUTPUT.HB_BANK_ID IS NOT NULL
                    THEN ARRAY_CAT(ARRAY_AGG(DISTINCT OBJECT_CONSTRUCT ('TYPE','PROVIDER','PROVIDER_ID',FINAL_EXCEL_OUTPUT.HB_PROVIDER_ID)),
                            ARRAY_AGG(OBJECT_CONSTRUCT('TYPE','BANK_ACCOUNT', 'BANK_ID', FINAL_EXCEL_OUTPUT.HB_BANK_ID)))
                    ELSE ARRAY_AGG(DISTINCT OBJECT_CONSTRUCT ('TYPE','PROVIDER','PROVIDER_ID',FINAL_EXCEL_OUTPUT.HB_PROVIDER_ID))
                END AS REFERENCES,
                ARRAY_CAT(
                            ARRAY_AGG(DISTINCT OBJECT_CONSTRUCT('LABEL','PRODUCT ENROLLMENT', 'VALUE', FINAL_EXCEL_OUTPUT.PRODUCT_ENROLLMENT)),
                                ARRAY_CAT(ARRAY_AGG(DISTINCT OBJECT_CONSTRUCT('LABEL','DISTINCT VCC ACCEPTORS', 'VALUE', FINAL_EXCEL_OUTPUT.PROVIDER_DISTINCT_ACCEPTORS)),
                                    ARRAY_CAT(ARRAY_AGG(DISTINCT OBJECT_CONSTRUCT('LABEL','TOTAL DECLINES', 'VALUE', PROVIDER_TOTAL_DECLINES)),
                                                ARRAY_CAT(ARRAY_AGG(DISTINCT OBJECT_CONSTRUCT('LABEL','PROVIDER TOTAL SETTLEMENT AMOUNT', 'VALUE', FINAL_EXCEL_OUTPUT.PROVIDER_TOTAL_SETTLEMENT_AMOUNT)),
                                                ARRAY_AGG(DISTINCT OBJECT_CONSTRUCT('LABEL','LAST EML REPORT DATE', 'VALUE', FINAL_EXCEL_OUTPUT.LAST_REPORT_DATE)))))) AS OTHER_INFO

            FROM FINAL_EXCEL_OUTPUT
            GROUP BY FINAL_EXCEL_OUTPUT.PROVIDER_GROUP_ID, FINAL_EXCEL_OUTPUT.HB_PROVIDER_ID,  FINAL_EXCEL_OUTPUT.HB_BANK_ID)

--------------------------------------------------------------------------------------------------------
-- FINAL OUTPUT COLUMNS AND FLATTEN ARRAYS
--------------------------------------------------------------------------------------------------------

   SELECT ROW_NUMBER() OVER (ORDER BY FINAL_ARRAY.PROVIDER_GROUP_ID)  AS HB_ALERTS_ID, -- ROW_NUMBER IS JUST HERE FOR EXAMPLE, GENERATE WITH NEW ID/GROUP_ID,GENERATE WITH NEW GROUP_ID
        CONCAT(RULES.RULE_ID,'_',FINAL_ARRAY.PROVIDER_GROUP_ID) AS ID,
        CURRENT_TIMESTAMP AS TRIGGERED_AT, -- this should be the row_cre_dt
        RULES.RULE,
        ARRAY_FLATTEN(ARRAY_UNIQUE_AGG((FINAL_ARRAY.REFERENCES))) AS REFERENCES,
        ARRAY_FLATTEN(ARRAY_UNIQUE_AGG((FINAL_ARRAY.OTHER_INFO))) AS OTHER_INFO
        
    FROM FINAL_ARRAY
    INNER JOIN (VALUES ('EXT-PMT-0002', 'Provider Reviews Based on VCC Activity') AS RULES (RULE_ID, RULE))
    GROUP BY FINAL_ARRAY.PROVIDER_GROUP_ID, RULES.RULE_ID, RULES.RULE


