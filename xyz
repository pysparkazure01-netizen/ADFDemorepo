--USE ROLE ENTERPRISE_ADMIN_INTERNAL_ONSHORE; 
--USE WAREHOUSE LEGAL_FRAUD_BI;

---Create Proc

--USE ROLE ENTERPRISE_ADMIN_INTERNAL_ONSHORE; 
--USE WAREHOUSE LEGAL_FRAUD_BI;

---Create Proc

CREATE OR REPLACE PROCEDURE DEV_FRAUD_WAREHOUSE.FRAUD_REPORTS_ENT.HUMMINGBIRD_ALERTS_COMM_ACCNT_PAYBLE_UPSERT_MONITORING()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS 
$$
DECLARE
VAR_SUCCESS_MESSAGE string;

BEGIN
VAR_SUCCESS_MESSAGE := 'SUCCESSFULLY COMLPETED';

CREATE OR REPLACE TABLE DEV_FRAUD_WAREHOUSE.FRAUD_REPORTS_ENT.STG_COMM_ACCT_PAYBLE as 


-- PROVIDER METRICS
WITH PROV_METRICS AS 
    (
    SELECT 
        PROVIDERID,
        COUNT(DISTINCT COALESCE(MERCHANTNAME, ACCEPTOR)) AS PROVIDER_DISTINCT_ACCEPTORS,
        COUNT
            (CASE WHEN AUTHSTATUS = 'Declined'
            THEN TXNID
            ELSE 0
            END) AS PROVIDER_TOTAL_DECLINES,
        SUM
            (CASE WHEN AUTHSTATUS = 'Settled'
            THEN PYMTAMT
            ELSE 0
            END) AS PROVIDER_TOTAL_SETTLEMENT_AMOUNT,
        MAX(YEARMONTH) AS LAST_REPORT_DATE
    FROM PROD_FRAUD_WAREHOUSE.SRC_EML.ZELIS_PROVIDER_REVIEW
    GROUP BY PROVIDERID
    ),
PROV_BANKS AS
(SELECT DISTINCT
    PROVIDERID,
    BA.HB_BANK_ID
FROM PROV_METRICS P
LEFT JOIN PROD_FRAUD_WAREHOUSE.MONITORING_ENT.BANK_ACCOUNTS BA
ON P.PROVIDERID = BA.ENTITY_ID
AND ENTITY_TYPE = 'Provider'
),
CURRENT_PROV_PRODUCT AS
(
    SELECT DISTINCT
        PPLS.PROVIDERID,
        PPLS.PRODUCTLINEID,
        PLL.NAME AS PRODUCTNAME,
        SL.NAME AS STATUS,
        PPLS.ENABLED,
        PPLS.LASTMODIFIED
    FROM PROD_FRAUD_WAREHOUSE.SRC_EML.ZELIS_PROVIDER_REVIEW PR
    LEFT JOIN PROD_FRAUD_WAREHOUSE.SRC_PYMT_PPSBACKEND.PPS_PROVIDERPRODUCTLINESTATUS PPLS
    ON PR.PROVIDERID = PPLS.PROVIDERID
    LEFT JOIN PROD_FRAUD_WAREHOUSE.SRC_PYMT_PPSBACKEND.PPS_PRODUCTLINELOOKUP PLL
    ON PPLS.PRODUCTLINEID = PLL.PRODUCTLINEID
    LEFT JOIN PROD_FRAUD_WAREHOUSE.SRC_PYMT_PPSBACKEND.PPS_STATUSLOOKUP SL
    ON PPLS.STATUSID = SL.STATUSID
    ORDER BY PROVIDERID
),
PROVIDER_PRODUCT_ENROLLMENT AS
(
    SELECT
        CURRENT_PROV_PRODUCT.PROVIDERID,
        ARRAY_AGG(
            OBJECT_CONSTRUCT
                (
                'STATUS', CURRENT_PROV_PRODUCT.STATUS, 
                'PRODUCT', CURRENT_PROV_PRODUCT.PRODUCTNAME, 
                'LASTMODIFIED', TO_DATE(LASTMODIFIED)
                )
            ) AS PRODUCT_ENROLLMENT
    FROM CURRENT_PROV_PRODUCT
    GROUP BY CURRENT_PROV_PRODUCT.PROVIDERID
),

GROUP_ID AS
(
SELECT PROVIDERID,
       CONCAT(PROVIDERID,'_', MAX(YEARMONTH)) AS PROVIDER_GROUP_ID
FROM PROD_FRAUD_WAREHOUSE.SRC_EML.ZELIS_PROVIDER_REVIEW
GROUP BY PROVIDERID
),
FINAL_EXCEL_OUTPUT AS
(
SELECT DISTINCT
    GROUP_ID.PROVIDER_GROUP_ID,
    P.HB_PROVIDER_ID,
    PROV_BANKS.HB_BANK_ID,
    GROUP_ID.PROVIDERID,
    PPE.PRODUCT_ENROLLMENT,
    TO_VARCHAR(PROV_METRICS.PROVIDER_DISTINCT_ACCEPTORS) AS PROVIDER_DISTINCT_ACCEPTORS,
    TO_VARCHAR(PROV_METRICS.PROVIDER_TOTAL_DECLINES) AS PROVIDER_TOTAL_DECLINES,
    TO_VARCHAR(PROV_METRICS.PROVIDER_TOTAL_SETTLEMENT_AMOUNT) AS PROVIDER_TOTAL_SETTLEMENT_AMOUNT,
    PROV_METRICS.LAST_REPORT_DATE
FROM GROUP_ID
LEFT JOIN PROD_FRAUD_WAREHOUSE.MONITORING_ENT.PROVIDERS P
ON GROUP_ID.PROVIDERID = P.SYSTEMPROVIDERID 
AND P.SOURCESYSTEMID = 6
LEFT JOIN PROV_METRICS
ON GROUP_ID.PROVIDERID = PROV_METRICS.PROVIDERID
LEFT JOIN PROVIDER_PRODUCT_ENROLLMENT PPE
ON GROUP_ID.PROVIDERID = PPE.PROVIDERID
LEFT JOIN PROV_BANKS
ON GROUP_ID.PROVIDERID = PROV_BANKS.PROVIDERID 
ORDER BY GROUP_ID.PROVIDERID
),


--------------------------------------------------------------------------------------------------------
-- CREATE ARRAYS
--------------------------------------------------------------------------------------------------------
    FINAL_ARRAY AS
            (SELECT DISTINCT
                FINAL_EXCEL_OUTPUT.PROVIDER_GROUP_ID,
                FINAL_EXCEL_OUTPUT.HB_PROVIDER_ID,
                CASE 
                    WHEN FINAL_EXCEL_OUTPUT.HB_BANK_ID IS NOT NULL
                    THEN ARRAY_CAT(ARRAY_AGG(DISTINCT OBJECT_CONSTRUCT ('TYPE','PROVIDER','PROVIDER_ID',FINAL_EXCEL_OUTPUT.HB_PROVIDER_ID)),
                            ARRAY_AGG(OBJECT_CONSTRUCT('TYPE','BANK_ACCOUNT', 'BANK_ID', FINAL_EXCEL_OUTPUT.HB_BANK_ID)))
                    ELSE ARRAY_AGG(DISTINCT OBJECT_CONSTRUCT ('TYPE','PROVIDER','PROVIDER_ID',FINAL_EXCEL_OUTPUT.HB_PROVIDER_ID))
                END AS REFERENCES,
                ARRAY_CAT(
                            ARRAY_AGG(DISTINCT OBJECT_CONSTRUCT('LABEL','PRODUCT ENROLLMENT', 'VALUE', FINAL_EXCEL_OUTPUT.PRODUCT_ENROLLMENT)),
                                ARRAY_CAT(ARRAY_AGG(DISTINCT OBJECT_CONSTRUCT('LABEL','DISTINCT VCC ACCEPTORS', 'VALUE', FINAL_EXCEL_OUTPUT.PROVIDER_DISTINCT_ACCEPTORS)),
                                    ARRAY_CAT(ARRAY_AGG(DISTINCT OBJECT_CONSTRUCT('LABEL','TOTAL DECLINES', 'VALUE', PROVIDER_TOTAL_DECLINES)),
                                                ARRAY_CAT(ARRAY_AGG(DISTINCT OBJECT_CONSTRUCT('LABEL','PROVIDER TOTAL SETTLEMENT AMOUNT', 'VALUE', FINAL_EXCEL_OUTPUT.PROVIDER_TOTAL_SETTLEMENT_AMOUNT)),
                                                ARRAY_AGG(DISTINCT OBJECT_CONSTRUCT('LABEL','LAST EML REPORT DATE', 'VALUE', FINAL_EXCEL_OUTPUT.LAST_REPORT_DATE)))))) AS OTHER_INFO

            FROM FINAL_EXCEL_OUTPUT
            GROUP BY FINAL_EXCEL_OUTPUT.PROVIDER_GROUP_ID, FINAL_EXCEL_OUTPUT.HB_PROVIDER_ID,  FINAL_EXCEL_OUTPUT.HB_BANK_ID), 
	FINAL_SELECT AS (

--------------------------------------------------------------------------------------------------------
-- FINAL OUTPUT COLUMNS AND FLATTEN ARRAYS
--------------------------------------------------------------------------------------------------------

   SELECT ROW_NUMBER() OVER (ORDER BY FINAL_ARRAY.PROVIDER_GROUP_ID)  AS HB_ALERTS_ID, -- ROW_NUMBER IS JUST HERE FOR EXAMPLE, GENERATE WITH NEW ID/GROUP_ID,GENERATE WITH NEW GROUP_ID
        CONCAT(RULES.RULE_ID,'_',FINAL_ARRAY.PROVIDER_GROUP_ID) AS ID,
        CURRENT_TIMESTAMP AS TRIGGERED_AT, -- this should be the row_cre_dt 
		/*The triggered_at column should always reflect the ROW_CRE_DT - I just use the CURRENT_TIMESTAMP as a filler for the proc preproduction.*/
		
        RULES.RULE,
        ARRAY_FLATTEN(ARRAY_UNIQUE_AGG((FINAL_ARRAY.REFERENCES))) AS REFERENCES,
        ARRAY_FLATTEN(ARRAY_UNIQUE_AGG((FINAL_ARRAY.OTHER_INFO))) AS OTHER_INFO
        
    FROM FINAL_ARRAY
    INNER JOIN (VALUES ('EXT-PMT-0002', 'Provider Reviews Based on VCC Activity') AS RULES (RULE_ID, RULE))
    GROUP BY FINAL_ARRAY.PROVIDER_GROUP_ID, RULES.RULE_ID, RULES.RULE
) 


--- This is the one I'm  making it a final select query for monitoring_ent.
select 
  case when a.HB_ALERTS_ID is null then DEV_FRAUD_WAREHOUSE.FRAUD_REPORTS_ENT.HB_ALERTS_ID.nextval 
       else a.HB_ALERTS_ID end as HB_ALERTS_ID,
  a.ID,
  a.RULE,
  a.TRIGGERED_AT,
  a.REFERENCES,
  a.OTHER_INFO,
  b.SOURCESYSTEMID,
  concat(b.SOURCESYSTEMID, '_', a.ID) as src_uniq_cd_gen,
  C.src_uniq_cd,
  case when C.src_uniq_cd is null then getdate() else C.row_cre_dt end as row_cre_dt,
  getdate() row_mod_dt,
  'N' EXCLUSION_FLAG  
from FINAL_SELECT a 
inner join PROD_ZDI_REFERENCES.PLATFORM.SOURCESYSTEM b
  on a.SOURCE_SYSTEM = b.SOURCESYSTEMNAME
left outer join DEV_FRAUD_WAREHOUSE.MONITORING_ENT.ALERTS C
  on concat(b.SOURCESYSTEMID, '_', a.ID) = c.src_uniq_cd;
  

DELETE FROM DEV_FRAUD_WAREHOUSE.MONITORING_ENT.ALERTS A
USING DEV_FRAUD_WAREHOUSE.FRAUD_REPORTS_ENT.STG_COMM_ACCT_PAYBLE B
WHERE A.SRC_UNIQ_CD = B.src_uniq_cd_gen;

INSERT INTO DEV_FRAUD_WAREHOUSE.MONITORING_ENT.ALERTS
SELECT
a.HB_ALERTS_ID,
a.ID,
a.TRIGGERED_AT,
a.RULE,
a.REFERENCES,
a.OTHER_INFO,
a.SOURCESYSTEMID,
a.src_uniq_cd_gen as src_uniq_cd,
a.row_cre_dt,
a.row_mod_dt,
a.exclusion_flag
FROM DEV_FRAUD_WAREHOUSE.FRAUD_REPORTS_ENT.STG_COMM_ACCT_PAYBLE A;

DROP TABLE DEV_FRAUD_WAREHOUSE.FRAUD_REPORTS_ENT.STG_COMM_ACCT_PAYBLE;


RETURN :VAR_SUCCESS_MESSAGE;

END;
$$
;
