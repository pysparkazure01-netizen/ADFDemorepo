CREATE OR REPLACE PROCEDURE DEV_FRAUD_WAREHOUSE.FRAUD_REPORTS_ENT.TINNPI_FINDER_RESULTS(
    NPI STRING,
    TIN STRING,
    MINDATE DATE
)
RETURNS STRING
LANGUAGE SQL
EXECUTE AS OWNER
AS
$$
BEGIN

    -- Step 1: Truncate table
    TRUNCATE TABLE DEV_FRAUD_WAREHOUSE.MONITORING_ENT.TINNPI_FINDER_RESULTS_V2;

    -- Step 2: Create table with SELECT
    CREATE OR REPLACE TABLE DEV_FRAUD_WAREHOUSE.MONITORING_ENT.TINNPI_FINDER_RESULTS_V2 AS
    WITH claims AS (
        SELECT 
            FC.SOURCESYSTEMCLAIMID AS SRC_CLAIM_ID,
            COALESCE(DIMDATERECEIVED.DATEDAY, '-1') AS RECEIVEDDATE,
            COALESCE(SERVICEFROM.DATEDAY, '-1') AS FROMDATEOFSERVICE,
            GETDATE() AS ROW_CRE_DT,
            FC.SOURCESYSTEMID AS SRC_SOURCESYSTEMID,
            FC.SRC_UNIQ_CD AS SRC_UNIQ_CD,
            FC.DIMPROVIDERKEY AS BILLPROVIDERKEY,
            FC.DIMRENDERINGPROVIDERKEY AS RENDERPROVIDERKEY,
            FC.DIMATTENDINGPROVIDERKEY AS ATTENDINGPROVIDERKEY,
            FC.DIMREFERRINGPROVIDERKEY AS REFERRINGPROVIDERKEY,
            FC.DIMSERVICELOCATIONKEY AS SERVICELOCATIONPROVIDERKEY,
            COALESCE(DIMPROVIDER.PROVIDERNPI, '-1') AS CLNSD_NPI,
            DEV_ZDI_REFERENCES.SOURCES_INTERNAL.ZDI_PROVIDER_CLEAN_TIN(DIMPROVIDER.PMTAXID) AS CLNSD_TAX_ID,
            COALESCE(DIMCLIENT.DIMCLIENTKEY, '-1') AS PAYERKEY,
            DIMCLIENT.FINANCEPARENT AS FINANCE_PARENT_NAME,
            COALESCE(DIMPROVIDER.DIMPROVIDERKEY, '-1') AS PROVIDERKEY
        FROM PROD_CCS_WAREHOUSE.CLAIMS_MART.FACTCLAIM FC
        LEFT JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMDATE DIMDATERECEIVED
            ON DIMDATERECEIVED.DIMDATEKEY = FC.DIMDATERECEIVEDKEY
        LEFT JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMDATE SERVICEFROM
            ON SERVICEFROM.DIMDATEKEY = FC.DIMDATESERVICEFROMKEY
        LEFT JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMPROVIDER DIMPROVIDER
            ON DIMPROVIDER.DIMPROVIDERKEY = FC.DIMPROVIDERKEY
        LEFT JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMCLIENT DIMCLIENT
            ON DIMCLIENT.DIMCLIENTKEY = FC.DIMCLIENTKEY
        WHERE FACTCLAIMID IS NOT NULL
    ),

    all_trnx AS (
        SELECT 
            c.SRC_SOURCESYSTEMID::INT AS SOURCESYSTEMID,
            c.SRC_CLAIM_ID::VARCHAR(500) AS SOURCESYSTEM_TRANSACTION_ID,
            COALESCE(c.RECEIVEDDATE, c.FROMDATEOFSERVICE, c.ROW_CRE_DT)::DATE AS TRANSACTION_DATE,
            CASE 
                WHEN TRANSACTION_DATE = c.RECEIVEDDATE THEN 1 
                WHEN TRANSACTION_DATE = c.FROMDATEOFSERVICE THEN 2 
                WHEN TRANSACTION_DATE = c.ROW_CRE_DT THEN 3 
            END::INT AS DATE_SRCE_ID,
            c.PAYERKEY::INT AS PAYERKEY,
            1::INT AS NPI_ROLE_ID,
            c.CLNSD_NPI::VARCHAR(100) AS NPI,
            c.CLNSD_TAX_ID::VARCHAR(100) AS TIN,
            c.FINANCE_PARENT_NAME
        FROM claims c
        INNER JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMPROVIDER prb 
            ON c.BILLPROVIDERKEY = prb.DIMPROVIDERKEY
        WHERE (c.CLNSD_NPI = NPI OR c.CLNSD_TAX_ID = TIN)
          AND TRANSACTION_DATE >= MINDATE

        UNION ALL
        SELECT 
            c.SRC_SOURCESYSTEMID::INT, c.SRC_CLAIM_ID::VARCHAR(500),
            COALESCE(c.RECEIVEDDATE, c.FROMDATEOFSERVICE, c.ROW_CRE_DT)::DATE,
            CASE 
                WHEN TRANSACTION_DATE = c.RECEIVEDDATE THEN 1 
                WHEN TRANSACTION_DATE = c.FROMDATEOFSERVICE THEN 2 
                WHEN TRANSACTION_DATE = c.ROW_CRE_DT THEN 3 
            END::INT,
            c.PAYERKEY::INT, 2::INT, c.CLNSD_NPI::VARCHAR(100), c.CLNSD_TAX_ID::VARCHAR(100), c.FINANCE_PARENT_NAME
        FROM claims c
        INNER JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMPROVIDER prb 
            ON c.SERVICELOCATIONPROVIDERKEY = prb.DIMPROVIDERKEY
        WHERE (c.CLNSD_NPI = NPI OR c.CLNSD_TAX_ID = TIN)
          AND TRANSACTION_DATE >= MINDATE

        UNION ALL
        SELECT 
            c.SRC_SOURCESYSTEMID::INT, c.SRC_CLAIM_ID::VARCHAR(500),
            COALESCE(c.RECEIVEDDATE, c.FROMDATEOFSERVICE, c.ROW_CRE_DT)::DATE,
            CASE 
                WHEN TRANSACTION_DATE = c.RECEIVEDDATE THEN 1 
                WHEN TRANSACTION_DATE = c.FROMDATEOFSERVICE THEN 2 
                WHEN TRANSACTION_DATE = c.ROW_CRE_DT THEN 3 
            END::INT,
            c.PAYERKEY::INT, 3::INT, c.CLNSD_NPI::VARCHAR(100), c.CLNSD_TAX_ID::VARCHAR(100), c.FINANCE_PARENT_NAME
        FROM claims c
        INNER JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMPROVIDER prb 
            ON c.RENDERPROVIDERKEY = prb.DIMPROVIDERKEY
        WHERE (c.CLNSD_NPI = NPI OR c.CLNSD_TAX_ID = TIN)
          AND TRANSACTION_DATE >= MINDATE

        UNION ALL
        SELECT 
            c.SRC_SOURCESYSTEMID::INT, c.SRC_CLAIM_ID::VARCHAR(500),
            COALESCE(c.RECEIVEDDATE, c.FROMDATEOFSERVICE, c.ROW_CRE_DT)::DATE,
            CASE 
                WHEN TRANSACTION_DATE = c.RECEIVEDDATE THEN 1 
                WHEN TRANSACTION_DATE = c.FROMDATEOFSERVICE THEN 2 
                WHEN TRANSACTION_DATE = c.ROW_CRE_DT THEN 3 
            END::INT,
            c.PAYERKEY::INT, 4::INT, c.CLNSD_NPI::VARCHAR(100), c.CLNSD_TAX_ID::VARCHAR(100), c.FINANCE_PARENT_NAME
        FROM claims c
        INNER JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMPROVIDER prb 
            ON c.ATTENDINGPROVIDERKEY = prb.DIMPROVIDERKEY
        WHERE (c.CLNSD_NPI = NPI OR c.CLNSD_TAX_ID = TIN)
          AND TRANSACTION_DATE >= MINDATE

        UNION ALL
        SELECT 
            c.SRC_SOURCESYSTEMID::INT, c.SRC_CLAIM_ID::VARCHAR(500),
            COALESCE(c.RECEIVEDDATE, c.FROMDATEOFSERVICE, c.ROW_CRE_DT)::DATE,
            CASE 
                WHEN TRANSACTION_DATE = c.RECEIVEDDATE THEN 1 
                WHEN TRANSACTION_DATE = c.FROMDATEOFSERVICE THEN 2 
                WHEN TRANSACTION_DATE = c.ROW_CRE_DT THEN 3 
            END::INT,
            c.PAYERKEY::INT, 5::INT, c.CLNSD_NPI::VARCHAR(100), c.CLNSD_TAX_ID::VARCHAR(100), c.FINANCE_PARENT_NAME
        FROM claims c
        INNER JOIN PROD_CCS_WAREHOUSE.CLAIMS_MART.DIMPROVIDER prb 
            ON c.REFERRINGPROVIDERKEY = prb.DIMPROVIDERKEY
        WHERE (c.CLNSD_NPI = NPI OR c.CLNSD_TAX_ID = TIN)
          AND TRANSACTION_DATE >= MINDATE
    )

    SELECT DISTINCT
        sys.SOURCESYSTEMNAME, 
        trx.SOURCESYSTEM_TRANSACTION_ID, 
        trx.TRANSACTION_DATE, 
        dsc.DATE_SRCE_COL, 
        trx.FINANCE_PARENT_NAME, 
        trx.TIN, 
        npi.NPI, 
        npi.ENTITY_TYPE_CODE, 
        npi.PROVIDER_NAME, 
        rol.NPI_ROLE
    FROM all_trnx trx
    LEFT JOIN DEV_FRAUD_WAREHOUSE.MONITORING_ENT.DIMSOURCESYSTEM sys 
        ON sys.SOURCESYSTEMID = trx.SOURCESYSTEMID
    LEFT JOIN DEV_FRAUD_WAREHOUSE.MONITORING_ENT.NPPES_NPI_THIN npi 
        ON trx.NPI = npi.NPI
    LEFT JOIN DEV_FRAUD_WAREHOUSE.MONITORING_ENT.CLAIM_NPI_ROLES rol 
        ON rol.NPI_ROLE_ID = trx.NPI_ROLE_ID
    LEFT JOIN DEV_FRAUD_WAREHOUSE.MONITORING_ENT.CLAIM_DATE_SOURCES dsc 
        ON dsc.DATE_SRCE_ID = trx.DATE_SRCE_ID
    ;

    RETURN 'Procedure executed successfully.';

END;
$$;
